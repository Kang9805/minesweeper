{% for row in board_data %}
    {% for cell in row %}
        {% if cell.is_revealed %}
            <div class="cell revealed {% if cell.is_mine %}mine{% endif %} {% if cell.value %}color-{{ cell.value }}{% endif %}">
                {% if cell.is_mine %}ðŸ’£{% else %}{{ cell.value }}{% endif %}
            </div>
        {% else %}
            <div class="cell {% if cell.is_flagged %}flagged{% endif %}"
                 data-row="{{ cell.row }}"
                 data-col="{{ cell.col }}"
                 hx-get="{% url 'click' cell.row cell.col %}"
                 hx-target="#game-board"
                 hx-swap="innerHTML">
                {% if cell.is_flagged %}ðŸš©{% endif %}
            </div>
        {% endif %}
    {% endfor %}
{% endfor %}

<style>
    .cell {
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
        -moz-user-select: none;
        touch-action: manipulation;
    }
</style>

<script>
(function() {
    const LONG_PRESS_MS = 500;

    function flagCell(cell) {
        const row = cell.dataset.row;
        const col = cell.dataset.col;
        if (!row || !col) {
            return;
        }
        htmx.ajax('GET', `/flag/${row}/${col}/`, {
            target: '#game-board',
            swap: 'innerHTML'
        });
    }

    function bindCellEvents(root) {
        const cells = root.querySelectorAll('.cell:not(.revealed)');

        cells.forEach(cell => {
            if (cell.dataset.longPressBound === '1') {
                return;
            }
            cell.dataset.longPressBound = '1';

            let pressTimer;
            let isLongPress = false;

            cell.addEventListener('touchstart', function(e) {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    cell.dataset.suppressClick = '1';
                    flagCell(cell);
                }, LONG_PRESS_MS);
            }, { passive: true });

            cell.addEventListener('touchmove', function() {
                clearTimeout(pressTimer);
                isLongPress = false;
            }, { passive: true });

            cell.addEventListener('touchend', function(e) {
                clearTimeout(pressTimer);
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, { passive: false });

            cell.addEventListener('click', function(e) {
                if (cell.dataset.suppressClick === '1') {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    delete cell.dataset.suppressClick;
                }
            });

            cell.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                flagCell(cell);
            });
        });
    }

    bindCellEvents(document);

    if (window.htmx) {
        htmx.onLoad(function(content) {
            bindCellEvents(content);
        });
    }
})();
</script>