{% for row in board_data %}
    {% for cell in row %}
        {% if cell.is_revealed %}
            <div class="cell revealed {% if cell.is_mine %}mine{% endif %} {% if cell.value %}color-{{ cell.value }}{% endif %}">
                {% if cell.is_mine %}üí£{% else %}{{ cell.value }}{% endif %}
            </div>
        {% else %}
            <div class="cell {% if cell.is_flagged %}flagged{% endif %}"
                 data-row="{{ cell.row }}"
                 data-col="{{ cell.col }}">
                {% if cell.is_flagged %}üö©{% endif %}
            </div>
        {% endif %}
    {% endfor %}
{% endfor %}

<style>
    .difficulty-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .difficulty-btn {
        padding: 10px 20px;
        font-size: 16px;
        border: 2px solid #667eea;
        border-radius: 6px;
        cursor: pointer;
        background-color: #667eea;
        color: white;
        font-weight: 600;
        transition: all 0.3s;
    }

    .difficulty-btn:hover {
        background-color: #764ba2;
        border-color: #764ba2;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .difficulty-btn:active {
        transform: translateY(0);
    }

    .cell {
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
        -moz-user-select: none;
        touch-action: manipulation;
    }
</style>

<script>
(function() {
    const LONG_PRESS_MS = 500;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

    function updateBoardFromState(state) {
        // Î≥¥Îìú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        for (let r = 0; r < state.board_data.length; r++) {
            for (let c = 0; c < state.board_data[r].length; c++) {
                const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                if (!cell) continue;
                
                const cellData = state.board_data[r][c];
                if (cellData.is_revealed && !cell.classList.contains('revealed')) {
                    // Í≥µÍ∞ú ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
                    const newCell = document.createElement('div');
                    newCell.className = `cell revealed ${cellData.is_mine ? 'mine' : ''} ${cellData.value ? `color-${cellData.value}` : ''}`;
                    newCell.textContent = cellData.is_mine ? 'üí£' : cellData.value;
                    cell.replaceWith(newCell);
                }
            }
        }
        
        // ÏÉÅÌÉú Î∞î ÏóÖÎç∞Ïù¥Ìä∏
        const statusBar = document.getElementById('status-bar');
        if (statusBar) {
            statusBar.dataset.won = state.won.toString();
            statusBar.dataset.gameOver = state.game_over.toString();
            const span = statusBar.querySelector('span');
            if (state.game_over) {
                span.textContent = 'üí• Í≤åÏûÑ Ïò§Î≤Ñ!';
            } else if (state.won) {
                span.textContent = 'üéâ ÏäπÎ¶¨!';
            } else {
                span.textContent = `üö© ÎÇ®ÏùÄ ÍπÉÎ∞ú: ${state.remaining_flags}`;
            }
        }
    }

    function flagCell(cell) {
        const row = cell.dataset.row;
        const col = cell.dataset.col;
        if (!row || !col) {
            return;
        }
        fetch(`/flag/${row}/${col}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            }
        }).then(r => {
            if (r.status === 204) {
                // ÍπÉÎ∞ú ÏÉÅÌÉú ÌÜ†Í∏Ä
                const isFlagged = cell.classList.contains('flagged');
                if (isFlagged) {
                    cell.classList.remove('flagged');
                    cell.textContent = '';
                } else {
                    cell.classList.add('flagged');
                    cell.textContent = 'üö©';
                }
                // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                return fetch('/api/game-state/', {
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                }).then(r => r.json());
            }
        }).then(data => {
            if (data) {
                updateBoardFromState(data);
            }
        }).catch(e => console.error('Flag error:', e));
    }

    function clickCell(cell) {
        const row = cell.dataset.row;
        const col = cell.dataset.col;
        if (!row || !col) {
            return;
        }
        fetch(`/click/${row}/${col}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            }
        }).then(r => {
            if (r.status === 204) {
                return fetch('/api/game-state/', {
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                }).then(r => r.json());
            }
        }).then(data => {
            if (data) {
                updateBoardFromState(data);
            }
        }).catch(e => console.error('Click error:', e));
    }

    function bindCellEvents(root) {
        const cells = root.querySelectorAll('.cell:not(.revealed)');

        cells.forEach(cell => {
            if (cell.dataset.longPressBound === '1') {
                return;
            }
            cell.dataset.longPressBound = '1';

            let pressTimer;
            let isLongPress = false;

            cell.addEventListener('touchstart', function(e) {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    cell.dataset.suppressClick = '1';
                    flagCell(cell);
                }, LONG_PRESS_MS);
            }, { passive: true });

            cell.addEventListener('touchmove', function() {
                clearTimeout(pressTimer);
                isLongPress = false;
            }, { passive: true });

            cell.addEventListener('touchend', function(e) {
                clearTimeout(pressTimer);
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, { passive: false });

            cell.addEventListener('click', function(e) {
                if (cell.dataset.suppressClick === '1') {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    delete cell.dataset.suppressClick;
                } else {
                    clickCell(cell);
                }
            });

            cell.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                flagCell(cell);
            });
        });
    }

    bindCellEvents(document);

    if (window.htmx) {
        htmx.onLoad(function(content) {
            bindCellEvents(content);
        });
    }
})();
</script>
